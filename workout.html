<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Rep Counter</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f4f8;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-group {
            display: flex;
            margin-bottom: 20px;
        }
        .exercise-weight-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .exercise-weight-group > * {
            flex: 1;
        }
        #exerciseSelect {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        #weightInput {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #repInput {
            flex-grow: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .full-width-button {
            width: 100%;
            border-radius: 4px;
            margin-top: 20px;
            background-color: #27ae60;
        }
        .full-width-button:hover {
            background-color: #219a52;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .button-group button {
            flex: 1;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .copy-button {
            background-color: #9b59b6;
            color: white;
        }
        .copy-button:hover {
            background-color: #8e44ad;
        }
        .clear-button {
            background-color: #e74c3c;
            color: white;
        }
        .clear-button:hover {
            background-color: #c0392b;
        }
        .stats {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #totalReps {
            font-size: 48px;
            font-weight: bold;
            color: #2c3e50;
            display: block;
            text-align: center;
        }
        #currentExerciseInfo {
            text-align: center;
            color: #7f8c8d;
            margin-top: 10px;
            font-size: 18px;
        }
        #countdown {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #e74c3c;
            margin-top: 10px;
        }
        #log {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #log h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        #flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.9);
            display: none;
            z-index: 1000;
        }
        #chartContainer {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .analytics-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .analytics-section h3 {
            margin-top: 0;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-item {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
        }
        .chart-item h4 {
            margin: 0 0 15px 0;
            color: #34495e;
            font-size: 14px;
            text-align: center;
        }
        .chart-item canvas {
            width: 100% !important;
            height: 200px !important;
        }
        .full-width-chart {
            grid-column: 1 / -1;
        }
        .full-width-chart canvas {
            height: 300px !important;
        }
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
        .settings {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .settings h3 {
            margin-top: 0;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .settings .input-group {
            display: flex;
            align-items: center;
        }
        .settings label {
            margin-right: 10px;
            font-weight: bold;
        }
        .settings input {
            flex-grow: 1;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .settings button {
            padding: 8px 15px;
            font-size: 14px;
        }
        #quickButtons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        #quickButtons button {
            flex: 1;
            margin: 0 5px;
            padding: 20px 0; /* Ensures the buttons are square */
            font-size: 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #quickButtons button:hover {
                        background-color: #2980b9;
        }
        
        /* Muscle Soreness Tracker Styles */
        #sorenessLog {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        #sorenessLog h3 {
            margin-top: 0;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        .soreness-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .muscle-item {
            display: flex;
            align-items: center;
        }
        .soreness-toggle {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #bdc3c7;
            background-color: #ecf0f1;
            color: #2c3e50;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .soreness-toggle:hover {
            border-color: #3498db;
            background-color: #d5dbdb;
        }
        .soreness-toggle.sore {
            background-color: #e74c3c;
            color: white;
            border-color: #c0392b;
        }
        .soreness-toggle.sore:hover {
            background-color: #c0392b;
        }
        .muscle-name {
            display: block;
        }
        @media (max-width: 768px) {
            .soreness-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .soreness-toggle {
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Workout Rep Counter</h1>
        
        <div class="exercise-weight-group">
            <select id="exerciseSelect">
                <option value="curls">Curls</option>
                <option value="push ups">Push Ups</option>
                <option value="overhead press">Overhead Press</option>
                <option value="pike push ups">Pike Push Ups</option>
            </select>
            <input type="number" id="weightInput" placeholder="Weight (lbs)" step="0.5">
        </div>
        
        <div id="quickButtons" class="input-group" style="display: none;">
            <!-- Buttons will be dynamically added here -->
        </div>
        <div class="input-group">
            <input type="number" id="repInput" placeholder="Enter reps">
            <button onclick="addReps()">Add Reps</button>
        </div>
        <div class="stats">
            <span id="totalReps">0</span>
            <small>Total Reps</small>
            <div id="currentExerciseInfo">Select exercise and weight</div>
            <div id="countdown">Next set in: 2:00</div>
        </div>
        <div id="chartContainer">
            <canvas id="repChart"></canvas>
        </div>
        <div id="log">
            <h3>Current Session History</h3>
            <div id="logEntries"></div>
        </div>
        <div id="sorenessLog">
            <h3>ðŸ’ª Muscle Soreness</h3>
            <div class="soreness-grid">
                <div class="muscle-item">
                    <button class="soreness-toggle" data-muscle="shoulders">
                        <span class="muscle-name">Shoulders</span>
                    </button>
                </div>
                <div class="muscle-item">
                    <button class="soreness-toggle" data-muscle="chest">
                        <span class="muscle-name">Chest</span>
                    </button>
                </div>
                <div class="muscle-item">
                    <button class="soreness-toggle" data-muscle="triceps">
                        <span class="muscle-name">Triceps</span>
                    </button>
                </div>
                <div class="muscle-item">
                    <button class="soreness-toggle" data-muscle="biceps">
                        <span class="muscle-name">Biceps</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="settings">
            <h3>Settings</h3>
            <div class="input-group">
                <label for="intervalInput">Rest Interval:</label>
                <input type="number" id="intervalInput" placeholder="Seconds">
                <button onclick="updateInterval()">Update</button>
            </div>
        </div>
        <div class="analytics-section">
            <h3>ðŸ“Š Long-Term Analytics & Trends</h3>
            <div class="chart-grid">
                <div class="chart-item full-width-chart">
                    <h4>Daily Volume Trend</h4>
                    <canvas id="volumeTrendChart"></canvas>
                </div>
                <div class="chart-item">
                    <h4>Exercise Progress</h4>
                    <canvas id="exerciseProgressChart"></canvas>
                </div>
                <div class="chart-item">
                    <h4>Average Reps per Set</h4>
                    <canvas id="avgRepsChart"></canvas>
                </div>
                <div class="chart-item">
                    <h4>Workout Frequency</h4>
                    <canvas id="frequencyChart"></canvas>
                </div>
                <div class="chart-item">
                    <h4>Rest Time Trends</h4>
                    <canvas id="restTimeChart"></canvas>
                </div>
            </div>
        </div>
        <div class="button-group">
            <button class="copy-button" onclick="copyWorkoutLogToClipboard()">Copy Workout Log to Clipboard</button>
            <button class="clear-button" onclick="clearWorkoutLog()">Clear Workout Log</button>
        </div>
    </div>
    <div id="flash"></div>

    <script>
        // Enhanced workout tracking with exercise and weight logging
        let totalReps = 0;
        let lastReps = 0;
        let setCount = 0;
        let countdownInterval;
        let restInterval = 120; // Default to 120 seconds (2 minutes)
        let currentWorkoutSession = [];
        let lastSetTime = null;
        let workoutStartTime = null;
        
        const repInput = document.getElementById('repInput');
        const weightInput = document.getElementById('weightInput');
        const exerciseSelect = document.getElementById('exerciseSelect');
        const intervalInput = document.getElementById('intervalInput');
        const totalRepsDisplay = document.getElementById('totalReps');
        const currentExerciseInfo = document.getElementById('currentExerciseInfo');
        const logDisplay = document.getElementById('logEntries');
                const flash = document.getElementById('flash');
        const countdownDisplay = document.getElementById('countdown');

        // Load saved interval from localStorage
        if (localStorage.getItem('restInterval')) {
            restInterval = parseInt(localStorage.getItem('restInterval'));
            intervalInput.value = restInterval;
        } else {
            intervalInput.value = restInterval; // Set default value
        }

        // Web Audio API context
        let audioContext;

        // Chart.js setup - Current Session Chart
        const ctx = document.getElementById('repChart').getContext('2d');
        const repChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Reps per Set',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Reps'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Set Number'
                        }
                    }
                }
            }
        });

        // Analytics Charts Setup
        let volumeTrendChart, exerciseProgressChart, avgRepsChart, frequencyChart, restTimeChart;

        function initializeAnalyticsCharts() {
            // Daily Volume Trend Chart
            const volumeCtx = document.getElementById('volumeTrendChart').getContext('2d');
            volumeTrendChart = new Chart(volumeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Total Reps per Day',
                        data: [],
                        borderColor: 'rgb(52, 152, 219)',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Total Reps' }
                        }
                    }
                }
            });

            // Exercise Progress Chart
            const exerciseCtx = document.getElementById('exerciseProgressChart').getContext('2d');
            exerciseProgressChart = new Chart(exerciseCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Max Reps' }
                        }
                    }
                }
            });

            // Average Reps per Set Chart
            const avgRepsCtx = document.getElementById('avgRepsChart').getContext('2d');
            avgRepsChart = new Chart(avgRepsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Reps',
                        data: [],
                        backgroundColor: 'rgba(155, 89, 182, 0.7)',
                        borderColor: 'rgb(155, 89, 182)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Average Reps' }
                        }
                    }
                }
            });

            // Workout Frequency Chart
            const frequencyCtx = document.getElementById('frequencyChart').getContext('2d');
            frequencyChart = new Chart(frequencyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Workouts',
                        data: [],
                        backgroundColor: 'rgba(46, 204, 113, 0.7)',
                        borderColor: 'rgb(46, 204, 113)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Sets' }
                        }
                    }
                }
            });

            // Rest Time Trends Chart
            const restTimeCtx = document.getElementById('restTimeChart').getContext('2d');
            restTimeChart = new Chart(restTimeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Rest Time (seconds)',
                        data: [],
                        borderColor: 'rgb(231, 76, 60)',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Rest Time (seconds)' }
                        }
                    }
                }
            });
        }

        function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playBeep() {
            if (!audioContext) {
                initAudio();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // 440 Hz - A4 note

            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function getCurrentExerciseInfo() {
            const exercise = exerciseSelect.value;
            const weight = weightInput.value;
            return {
                exercise: exercise,
                weight: weight ? parseFloat(weight) : null
            };
        }

        function updateCurrentExerciseDisplay() {
            const info = getCurrentExerciseInfo();
            const weightText = info.weight ? ` @ ${info.weight} lbs` : '';
            currentExerciseInfo.textContent = `${info.exercise}${weightText}`;
        }

        function addReps(reps = null) {
            const exerciseInfo = getCurrentExerciseInfo();
            
            if (!exerciseInfo.exercise) {
                alert('Please select an exercise first');
                return;
            }

            reps = reps !== null ? reps : (repInput.value ? parseInt(repInput.value) : lastReps);
            if (reps > 0) {
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                // Calculate rest time from previous set
                let restTime = null;
                if (lastSetTime) {
                    restTime = Math.round((now.getTime() - lastSetTime.getTime()) / 1000);
                }
                
                // Initialize workout session if this is the first set
                if (workoutStartTime === null) {
                    workoutStartTime = now;
                }
                
                totalReps += reps;
                lastReps = reps;
                setCount++;
                totalRepsDisplay.textContent = totalReps;
                
                // Create detailed set record
                const setRecord = {
                    setNumber: setCount,
                    exercise: exerciseInfo.exercise,
                    weight: exerciseInfo.weight,
                    reps: reps,
                    timestamp: now.toISOString(),
                    timeString: timeString,
                    restTimeSeconds: restTime,
                    restTimeFormatted: restTime ? formatTime(restTime) : 'N/A (first set)'
                };
                
                // Add to current session
                currentWorkoutSession.push(setRecord);
                
                // Save to localStorage
                saveToWorkoutLog(setRecord);
                
                // Update display
                const restTimeDisplay = restTime ? ` (Rest: ${formatTime(restTime)})` : ' (First set)';
                logDisplay.innerHTML = `<p>Set ${setCount}: ${reps} reps - ${exerciseInfo.exercise}${exerciseInfo.weight ? ` @ ${exerciseInfo.weight} lbs` : ''} - ${timeString}${restTimeDisplay}</p>` + logDisplay.innerHTML;
                
                repInput.value = '';
                lastSetTime = now;
                startTimer();
                updateChart(reps);
                updateCurrentExerciseDisplay();
                updateAnalyticsCharts(); // Update long-term analytics
                
                // Show and update quick buttons
                updateQuickButtons();
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            if (minutes > 0) {
                return `${minutes}m ${remainingSeconds}s`;
            }
            return `${remainingSeconds}s`;
        }

        function saveToWorkoutLog(setRecord) {
            let workoutHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            workoutHistory.push(setRecord);
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
        }

        function generateWorkoutLogText() {
            const workoutHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            
            if (workoutHistory.length === 0) {
                return 'No workout history found.';
            }
            
            let logText = 'COMPLETE WORKOUT LOG\n';
            logText += '======================\n\n';
            
            // Group by date
            const groupedByDate = {};
            workoutHistory.forEach(record => {
                const date = new Date(record.timestamp).toLocaleDateString();
                if (!groupedByDate[date]) {
                    groupedByDate[date] = [];
                }
                groupedByDate[date].push(record);
            });
            
            // Generate log for each date
            Object.keys(groupedByDate).sort().reverse().forEach(date => {
                logText += `DATE: ${date}\n`;
                logText += '-'.repeat(50) + '\n';
                
                const dayRecords = groupedByDate[date];
                
                // Group by exercise within the day
                const exerciseGroups = {};
                dayRecords.forEach(record => {
                    const exerciseKey = `${record.exercise}${record.weight ? ` @ ${record.weight} lbs` : ''}`;
                    if (!exerciseGroups[exerciseKey]) {
                        exerciseGroups[exerciseKey] = [];
                    }
                    exerciseGroups[exerciseKey].push(record);
                });
                
                Object.keys(exerciseGroups).forEach(exerciseKey => {
                    logText += `\n${exerciseKey}:\n`;
                    const sets = exerciseGroups[exerciseKey];
                    
                    sets.forEach((record, index) => {
                        const setNum = index + 1;
                        logText += `  Set ${setNum}: ${record.reps} reps at ${record.timeString}`;
                        if (record.restTimeFormatted && record.restTimeFormatted !== 'N/A (first set)') {
                            logText += ` (Rest: ${record.restTimeFormatted})`;
                        }
                        logText += '\n';
                    });
                    
                    // Calculate totals for this exercise
                    const totalReps = sets.reduce((sum, record) => sum + record.reps, 0);
                    const avgReps = (totalReps / sets.length).toFixed(1);
                    logText += `  Total: ${totalReps} reps across ${sets.length} sets (avg: ${avgReps} reps/set)\n`;
                });
                
                // Day summary
                const dayTotalReps = dayRecords.reduce((sum, record) => sum + record.reps, 0);
                const dayTotalSets = dayRecords.length;
                const uniqueExercises = Object.keys(exerciseGroups).length;
                
                logText += `\nDAY SUMMARY: ${dayTotalReps} total reps, ${dayTotalSets} sets, ${uniqueExercises} exercise(s)\n`;
                logText += '\n' + '='.repeat(50) + '\n\n';
            });
            
            // Overall statistics
            const totalWorkouts = Object.keys(groupedByDate).length;
            const totalSets = workoutHistory.length;
            const totalReps = workoutHistory.reduce((sum, record) => sum + record.reps, 0);
            const uniqueExercises = [...new Set(workoutHistory.map(r => r.exercise))];
            
            logText += 'OVERALL STATISTICS:\n';
            logText += '==================\n';
            logText += `Total workout days: ${totalWorkouts}\n`;
            logText += `Total sets completed: ${totalSets}\n`;
            logText += `Total reps completed: ${totalReps}\n`;
            logText += `Average reps per set: ${(totalReps / totalSets).toFixed(1)}\n`;
            logText += `Exercises performed: ${uniqueExercises.join(', ')}\n`;
            logText += `Average sets per workout: ${(totalSets / totalWorkouts).toFixed(1)}\n`;
            
            return logText;
        }

        async function copyWorkoutLogToClipboard() {
            try {
                const logText = generateWorkoutLogTextWithSoreness();
                
                // Try using the modern Clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(logText);
                    alert('Workout log copied to clipboard!');
                } else {
                    // Fallback for older browsers or non-secure contexts
                    const textArea = document.createElement('textarea');
                    textArea.value = logText;
                    textArea.style.position = 'absolute';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    textArea.setSelectionRange(0, 99999); // For mobile devices
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        alert('Workout log copied to clipboard!');
                    } else {
                        throw new Error('Copy command failed');
                    }
                }
            } catch (err) {
                console.error('Failed to copy workout log: ', err);
                alert('Failed to copy to clipboard. Your browser may not support this feature. Please try using a modern browser with HTTPS.');
            }
        }

        function updateAnalyticsCharts() {
            const workoutHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            
            if (workoutHistory.length === 0) {
                return; // No data to display
            }

            updateVolumeTrendChart(workoutHistory);
            updateExerciseProgressChart(workoutHistory);
            updateAvgRepsChart(workoutHistory);
            updateFrequencyChart(workoutHistory);
            updateRestTimeChart(workoutHistory);
        }

        function updateVolumeTrendChart(workoutHistory) {
            // Group by date and sum reps
            const dailyVolume = {};
            workoutHistory.forEach(record => {
                const date = new Date(record.timestamp).toLocaleDateString();
                dailyVolume[date] = (dailyVolume[date] || 0) + record.reps;
            });

            const sortedDates = Object.keys(dailyVolume).sort((a, b) => new Date(a) - new Date(b));
            const volumes = sortedDates.map(date => dailyVolume[date]);

            volumeTrendChart.data.labels = sortedDates;
            volumeTrendChart.data.datasets[0].data = volumes;
            volumeTrendChart.update();
        }

        function updateExerciseProgressChart(workoutHistory) {
            // Track max reps per exercise over time
            const exerciseData = {};
            const colors = ['rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 205, 86)', 'rgb(75, 192, 192)'];
            
            workoutHistory.forEach(record => {
                const date = new Date(record.timestamp).toLocaleDateString();
                if (!exerciseData[record.exercise]) {
                    exerciseData[record.exercise] = {};
                }
                exerciseData[record.exercise][date] = Math.max(
                    exerciseData[record.exercise][date] || 0, 
                    record.reps
                );
            });

            const allDates = [...new Set(workoutHistory.map(r => new Date(r.timestamp).toLocaleDateString()))]
                .sort((a, b) => new Date(a) - new Date(b));

            exerciseProgressChart.data.labels = allDates;
            exerciseProgressChart.data.datasets = Object.keys(exerciseData).map((exercise, index) => ({
                label: exercise,
                data: allDates.map(date => exerciseData[exercise][date] || 0),
                borderColor: colors[index % colors.length],
                tension: 0.3,
                fill: false
            }));
            exerciseProgressChart.update();
        }

        function updateAvgRepsChart(workoutHistory) {
            // Calculate average reps per exercise
            const exerciseStats = {};
            
            workoutHistory.forEach(record => {
                if (!exerciseStats[record.exercise]) {
                    exerciseStats[record.exercise] = { totalReps: 0, totalSets: 0 };
                }
                exerciseStats[record.exercise].totalReps += record.reps;
                exerciseStats[record.exercise].totalSets += 1;
            });

            const exercises = Object.keys(exerciseStats);
            const avgReps = exercises.map(ex => 
                (exerciseStats[ex].totalReps / exerciseStats[ex].totalSets).toFixed(1)
            );

            avgRepsChart.data.labels = exercises;
            avgRepsChart.data.datasets[0].data = avgReps;
            avgRepsChart.update();
        }

        function updateFrequencyChart(workoutHistory) {
            // Show sets per exercise
            const exerciseCounts = {};
            
            workoutHistory.forEach(record => {
                exerciseCounts[record.exercise] = (exerciseCounts[record.exercise] || 0) + 1;
            });

            const exercises = Object.keys(exerciseCounts);
            const counts = exercises.map(ex => exerciseCounts[ex]);

            frequencyChart.data.labels = exercises;
            frequencyChart.data.datasets[0].data = counts;
            frequencyChart.update();
        }

        function updateRestTimeChart(workoutHistory) {
            // Calculate average rest time per day (excluding first sets)
            const dailyRestTimes = {};
            
            workoutHistory.forEach(record => {
                if (record.restTimeSeconds !== null) {
                    const date = new Date(record.timestamp).toLocaleDateString();
                    if (!dailyRestTimes[date]) {
                        dailyRestTimes[date] = [];
                    }
                    dailyRestTimes[date].push(record.restTimeSeconds);
                }
            });

            const sortedDates = Object.keys(dailyRestTimes).sort((a, b) => new Date(a) - new Date(b));
            const avgRestTimes = sortedDates.map(date => {
                const times = dailyRestTimes[date];
                return times.reduce((sum, time) => sum + time, 0) / times.length;
            });

            restTimeChart.data.labels = sortedDates;
            restTimeChart.data.datasets[0].data = avgRestTimes;
            restTimeChart.update();
        }

        function clearWorkoutLog() {
            const workoutHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            
            if (workoutHistory.length === 0) {
                alert('No workout history to clear.');
                return;
            }
            
            const totalSets = workoutHistory.length;
            const totalReps = workoutHistory.reduce((sum, record) => sum + record.reps, 0);
            const totalWorkouts = [...new Set(workoutHistory.map(record => 
                new Date(record.timestamp).toLocaleDateString()
            ))].length;
            
            const confirmMessage = `Are you sure you want to clear ALL workout history?\n\n` +
                                 `This will permanently delete:\n` +
                                 `â€¢ ${totalWorkouts} workout day(s)\n` +
                                 `â€¢ ${totalSets} total sets\n` +
                                 `â€¢ ${totalReps} total reps\n\n` +
                                 `This action cannot be undone!`;
            
            if (confirm(confirmMessage)) {
                // Double confirmation for safety
                if (confirm('Are you absolutely sure? This will delete ALL your workout data forever!')) {
                    localStorage.removeItem('workoutHistory');
                    alert('Workout log cleared successfully.');
                    // Clear analytics charts
                    updateAnalyticsCharts();
                } else {
                    alert('Workout log clear cancelled.');
                }
            } else {
                alert('Workout log clear cancelled.');
            }
        }

        function updateChart(reps) {
            repChart.data.labels.push(setCount);
            repChart.data.datasets[0].data.push(reps);
            repChart.update();
        }

        function updateInterval() {
            const newInterval = parseInt(intervalInput.value);
            if (newInterval > 0) {
                restInterval = newInterval;
                localStorage.setItem('restInterval', restInterval);
                alert(`Rest interval updated to ${restInterval} seconds`);
            } else {
                alert('Please enter a valid interval greater than 0');
            }
        }

        function startTimer() {
            clearInterval(countdownInterval);
            let timeLeft = restInterval; // Use the restInterval instead of hardcoded 120
            updateCountdown(timeLeft);

            countdownInterval = setInterval(() => {
                timeLeft--;
                updateCountdown(timeLeft);

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    playBeep();
                    flash.style.display = 'block';
                    setTimeout(() => {
                        flash.style.display = 'none';
                    }, 500);
                }
            }, 1000);
        }

        function updateCountdown(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            countdownDisplay.textContent = `Next set in: ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function updateQuickButtons() {
            const quickButtonsContainer = document.getElementById('quickButtons');
            quickButtonsContainer.innerHTML = ''; // Clear existing buttons
            quickButtonsContainer.style.display = 'flex'; // Show the container

            for (let i = lastReps - 2; i <= lastReps + 2; i++) {
                if (i > 0) { // Only create buttons for positive reps
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.onclick = () => addReps(i);
                    quickButtonsContainer.appendChild(button);
                }
            }
        }

        // Event listeners
        repInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                addReps();
            }
        });

        exerciseSelect.addEventListener('change', updateCurrentExerciseDisplay);
        weightInput.addEventListener('input', updateCurrentExerciseDisplay);

        // Initialize audio context on user interaction
        document.body.addEventListener('click', initAudio, { once: true });

        // Muscle Soreness Tracking
        let sorenessStatus = {};
        
        function initializeSorenessTracker() {
            // Add event listeners to all soreness toggle buttons
            document.querySelectorAll('.soreness-toggle').forEach(button => {
                button.addEventListener('click', function() {
                    const muscle = this.dataset.muscle;
                    toggleMuscleSoreness(muscle);
                });
            });
            
            // Load today's soreness data
            loadTodaysSorenessData();
        }
        
        function toggleMuscleSoreness(muscle) {
            const button = document.querySelector(`[data-muscle="${muscle}"]`);
            const isSore = button.classList.contains('sore');
            
            if (isSore) {
                // Remove soreness
                button.classList.remove('sore');
                delete sorenessStatus[muscle];
                removeSorenessEntry(muscle);
            } else {
                // Add soreness
                button.classList.add('sore');
                const now = new Date();
                const sorenessEntry = {
                    muscle: muscle,
                    sore: true,
                    timestamp: now.toISOString(),
                    date: now.toLocaleDateString()
                };
                sorenessStatus[muscle] = sorenessEntry;
                saveSorenessEntry(sorenessEntry);
            }
        }
        
        function saveSorenessEntry(entry) {
            let sorenessHistory = JSON.parse(localStorage.getItem('sorenessHistory') || '[]');
            
            // Remove any previous entry for this muscle today
            const today = new Date().toLocaleDateString();
            sorenessHistory = sorenessHistory.filter(item => 
                !(item.muscle === entry.muscle && item.date === today)
            );
            
            sorenessHistory.push(entry);
            localStorage.setItem('sorenessHistory', JSON.stringify(sorenessHistory));
        }
        
        function removeSorenessEntry(muscle) {
            let sorenessHistory = JSON.parse(localStorage.getItem('sorenessHistory') || '[]');
            const today = new Date().toLocaleDateString();
            
            // Remove entry for this muscle today
            sorenessHistory = sorenessHistory.filter(item => 
                !(item.muscle === muscle && item.date === today)
            );
            
            localStorage.setItem('sorenessHistory', JSON.stringify(sorenessHistory));
        }
        
        function loadTodaysSorenessData() {
            const sorenessHistory = JSON.parse(localStorage.getItem('sorenessHistory') || '[]');
            const today = new Date().toLocaleDateString();
            
            // Clear current status
            sorenessStatus = {};
            
            // Reset all buttons
            document.querySelectorAll('.soreness-toggle').forEach(button => {
                button.classList.remove('sore');
            });
            
            // Filter entries for today and restore state
            const todaysEntries = sorenessHistory.filter(entry => entry.date === today && entry.sore);
            
            todaysEntries.forEach(entry => {
                const button = document.querySelector(`[data-muscle="${entry.muscle}"]`);
                if (button) {
                    button.classList.add('sore');
                    sorenessStatus[entry.muscle] = entry;
                }
            });
        }
        
        // Update the generateWorkoutLogText function to include soreness data
        function generateWorkoutLogTextWithSoreness() {
            let logText = generateWorkoutLogText();
            
            // Add soreness data
            const sorenessHistory = JSON.parse(localStorage.getItem('sorenessHistory') || '[]');
            
            if (sorenessHistory.length > 0) {
                logText += '\n\n' + '='.repeat(50) + '\n';
                logText += 'MUSCLE SORENESS HISTORY\n';
                logText += '='.repeat(50) + '\n\n';
                
                // Group by date
                const groupedByDate = {};
                sorenessHistory.forEach(entry => {
                    if (entry.sore) { // Only include sore muscles
                        if (!groupedByDate[entry.date]) {
                            groupedByDate[entry.date] = [];
                        }
                        groupedByDate[entry.date].push(entry);
                    }
                });
                
                // Generate log for each date
                Object.keys(groupedByDate).sort().reverse().forEach(date => {
                    logText += `DATE: ${date}\n`;
                    logText += '-'.repeat(30) + '\n';
                    
                    const dayEntries = groupedByDate[date];
                    const soreList = dayEntries.map(entry => 
                        entry.muscle.charAt(0).toUpperCase() + entry.muscle.slice(1)
                    ).join(', ');
                    
                    logText += `Sore muscles: ${soreList}\n\n`;
                });
            }
            
            return logText;
        }

        // Initialize analytics charts and display
        initializeAnalyticsCharts();
        updateAnalyticsCharts(); // Load any existing data
        updateCurrentExerciseDisplay();
        initializeSorenessTracker();
    </script>
</body>
</html>
